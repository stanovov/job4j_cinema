<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <title>Hello, world!</title>
</head>
<body>
<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.4.1.min.js" ></script>
<script type='text/javascript' src="https://rawgit.com/RobinHerbots/jquery.inputmask/3.x/dist/jquery.inputmask.bundle.js"></script>
<script>
    let SESSION_ID;
    let ROW;
    let CELL;

    $(document).ready(function () {
        initMasks();
        outTitle();
    });

    function initMasks() {
        $(":input").inputmask();
        $("#phone").inputmask({
            mask: '+7 (999) 999-99-99',
            placeholder: ' ',
            showMaskOnHover: false,
            showMaskOnFocus: false,
            onBeforePaste: function (pastedValue, opts) {
                var processedValue = pastedValue;
                return processedValue;
            }
        });
    }

    function outTitle() {
        let params = new URLSearchParams(document.location.search.substring(1));
        SESSION_ID = +params.get("session_id");
        ROW = +params.get("row");
        CELL = +params.get("cell");
        let session = null;
        if (SESSION_ID === 1) {
            session = '10:00';
        } else if (SESSION_ID === 2) {
            session = '13:30';
        } else if (SESSION_ID === 3) {
            session = '17:00';
        } else if (SESSION_ID === 4) {
            session = '20:30';
        } else if (SESSION_ID === 5) {
            session = '00:00';
        }
        $('#title').text(`Вы выбрали сеанс на ${session} ряд ${ROW} место ${CELL}, Сумма : 500 рублей.`);
    }

    function parsePhone() {
        return $('#phone').val()
            .replaceAll(' ', '')
            .replaceAll('-', '')
            .replace(')', '')
            .replace('(', '');
    }

    function validate() {
        let items = [];
        let phone = parsePhone();
        if ($('#username').val() === '') {
            items.push('ФИО');
        }
        if (phone === '' || phone.length !== 12) {
            items.push('Номер телефона');
        }
        let text = '';
        if (items.length > 0) {
            for (let item of items) {
                text += (text === '') ? item : ', ' + item;
            }
            text = 'Необходимо заполнить обязательные поля: ' + text;
        }
        $('#notification').text(text);
        return items.length === 0;
    }

    function payment() {
        $('#notification').prop("style", "color: red");
        if (validate()) {
            $.ajax({
                type: 'POST',
                url: 'http://localhost:8080/cinema/hall',
                data: JSON.stringify({
                    sessionId: SESSION_ID,
                    row: ROW,
                    cell: CELL,
                    account: {
                        username: $('#username').val(),
                        email: $('#email').val(),
                        phone: parsePhone()
                    }
                }),
                dataType: 'text'
            }).done(function(data) {
                if (data === '200 OK') {
                    $('#notification').prop("style", "color: green");
                    $('#notification').text('Билет успешно забронирован. '
                        + 'Через несколько секунд Вас перенаправит на главную страницу...');
                    setTimeout(() => {window.location.href = 'http://localhost:8080/cinema/index.html'}, 5000);
                } else {
                    $('#notification').text(data);
                }
            }).fail(function(err) {
                console.log(err);
            });
        }
    }
</script>
<div class="container">
    <div class="row pt-3">
        <h3 id="title"></h3>
    </div>
    <div class="row">
        <form>
            <div class="form-group">
                <label for="username">ФИО</label>
                <input type="text" class="form-control" id="username" placeholder="ФИО">
            </div>
            <div class="form-group">
                <label for="phone">Номер телефона</label>
                <input type="text" class="form-control" id="phone" data-inputmask="'alias': 'phonebe'" placeholder="Номер телефона">
            </div>
            <div class="form-group">
                <label for="phone">Электронная почта</label>
                <input type="text" class="form-control" id="email" data-inputmask="'alias': 'email'" placeholder="Email">
            </div>
            <button type="button" class="btn btn-success" onclick="payment()">Оплатить</button>
        </form>
    </div>
    <div class="row pt-3">
        <label id="notification" style="color: red"></label>
    </div>
</div>
</body>
</html>